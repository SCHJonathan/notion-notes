# ElasticSearch. An intro.

## **0. ä¸€å¥è¯æ¦‚æ‹¬ElasticSearch**

[Elasticsearch](https://www.elastic.co/elasticsearch/)ï¼ˆç®€ç§°ESï¼‰æ˜¯ä¸€ä¸ª**åˆ†å¸ƒå¼ã€å¯æ‰©å±•ã€æ¥è¿‘å®æ—¶(Near real-time)** çš„æœç´¢ä¸æ•°æ®åˆ†æå¼•æ“ã€‚ESä¸ä»…ä»…æ”¯æŒå…¨æ–‡æœç´¢ï¼Œè¿˜æ”¯æŒç»“æ„åŒ–æœç´¢ã€æ•°æ®åˆ†æã€å¤æ‚çš„è¯­è¨€å¤„ç†ã€åœ°ç†ä½ç½®å’Œå¯¹è±¡é—´å…³è”å…³ç³»ç­‰ã€‚

## 1. åŸºç¡€æ¦‚å¿µ:

ä¸ºäº†èƒ½å¤Ÿæ›´è½»æ¾çš„é˜…è¯»æœ¬æ–‡, å…ˆå¿«é€Ÿçš„ä»‹ç»ä¸‹ESçš„ä¸€äº›åŸºæœ¬æœ¯è¯­, æœ¯è¯­æ ¹æ®åŒ…å«å…³ç³»é€çº§é€’å‡:

- Cluster: å°±æ˜¯é›†ç¾¤, åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ (node), æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ªESå®ä¾‹
- ES Index: ESå­˜å‚¨æ•°æ®çš„åœ°æ–¹, å¯ä»¥æš‚æ—¶ç†è§£ä¸ºRDBä¸­çš„database
- Type: å­˜æ”¾æ•°æ®Objectå®šä¹‰, å¯ä»¥æš‚æ—¶ç†è§£ä¸ºRDBä¸­çš„table
- Document: æ•°æ®, JSONæ ¼å¼
- Field: å­—æ®µéƒ½æ˜¯Inverted Indexed (å³å¯æœç´¢, æ²¡æœ‰è¢«Inverted Indexçš„å­—æ®µä¸å¯æœç´¢),

## 2. ä¸ºä»€ä¹ˆç”¨ES

- **ç®€æ´æ–¹ä¾¿, æ˜“ä¸Šæ‰‹**

    ESæœ¬è´¨ä¸Šæ˜¯[Apache Lucene](https://lucene.apache.org/)çš„çš„ä¸€ä¸ªæœåŠ¡å±‚å°è£…ï¼ŒLuceneå¯ä»¥è¯´æ˜¯å½“ä¸‹æœ€å…ˆè¿›ã€é«˜æ€§èƒ½ã€å…¨åŠŸèƒ½çš„æœç´¢å¼•æ“åº“ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿååˆ†æ˜æ˜¾ï¼ŒLuceneæ˜¯ä¸ªJavaåº“ï¼Œä¸”åŸç†ååˆ†å¤æ‚. ESå°†Luceneçš„è¯¸å¤šä¼˜è‰¯ç‰¹æ€§ä»¥åŠåˆ†å¸ƒå¼æ“ä½œå°è£…æˆæ–¹ä¾¿çš„JSON based RESTful APIã€‚ä»å¼€å‘è€…è§’åº¦æ¥çœ‹, å°±æ— é¡»ç»å°½è„‘æ±æƒ³åŠæ³•æ•´åˆè¿™ä¸ªåº“åˆ°é¡¹ç›®, å¹¶å®ç°åˆ†å¸ƒå¼æ“ä½œäº†ã€‚

- **åˆ†å¸ƒå¼ + é«˜å¯ç”¨æ€§**
    - æ‰€æœ‰çš„Indexéƒ½èƒ½é…ç½®åˆ†ç‰‡(sharding)
    - æ¯ä¸ªåˆ†ç‰‡éƒ½å¯é…ç½®å¤šä¸ªå‰¯æœ¬(replica)
    - æ¯ä¸ªåˆ†ç‰‡å‰¯æœ¬å‡å¯ä»¥ç”¨äºæœç´¢/è¯»å–/æ’å…¥æ–°æ•°æ®
- **æ¥è¿‘å®æ—¶çš„æœç´¢é€Ÿåº¦ Near-real-time**

## 3. å®é™…æ“ä½œ

æ¦‚å¿µéƒ½æ˜¯æŠ½è±¡çš„, å’±ä»¬æ¥çœ‹ä¸€äº›å®é™…æ“ä½œå§

### 3.0 åŸºç¡€CRUD

é€šè¿‡HTTPçš„Verb (PUT, DELETE, POST, GET, HEAD) æ¥åŒºåˆ†å¯¹ESçš„ä¸åŒæ“ä½œ

è¯·æ±‚æ ¼å¼: `<host>:<port>/<index>/<type>/<endpoint>?<parameters>`

> Upsert æ•°æ®æ›´æ–°æ’å…¥

åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­, æˆ‘ä»¬ä¼šæŠŠâ€œJohn Smithâ€çš„ä¸€äº›ä¿¡æ¯æ’å…¥åˆ° `megacorp` è¿™ä¸ª ES Index ä¸­çš„ `employee` Type ä¸‹ (å¯¹åº”RDBä¸­çš„ `megacorp` database ä¸­çš„ `employee` table)

è¯·æ±‚ç»“å°¾çš„`pretty`ç›®çš„æ˜¯ `jsonify` è¿”å›ç»“æœ

```bash
curl -X PUT "localhost:9200/megacorp/employee/1?pretty" 
     -H 'Content-Type: application/json' 
     -data '
        {
            "first_name" : "John",
            "last_name" :  "Smith",
            "age" :        25,
            "about" :      "I love to go rock climbing",
            "interests": [ "sports", "music" ]
        }
        '

```

è¿”å›

```json
{
    "_index" : "megacorp",
    "_type" : "employee",
    "_id" : "1",
    "_version" : 1,
    "result" : "created",
    "_shards" : {
        "total" : 2,
        "successful" : 1,
        "failed" : 0
    },
    "_seq_no" : 0,
    "_primary_term" : 1
}

```

å’±ä»¬æ¥çœ‹ä¸‹è¿”å›ä¸­çš„å­—æ®µ:

- `_index`, `_type`, `_id` å¯¹åº”æ’å…¥çš„ ES Index, Type å, ä»¥åŠæ’å…¥åè¿”å›æ’å…¥æ•°æ®çš„ Document ID
- `_version`, `_seq_no`, `_primary_term` ES é€šè¿‡ä¹è§‚é”ä¸­çš„ç‰ˆæœ¬å·æœºåˆ¶æ¥å®ç°å¹¶å‘æ§åˆ¶. åœ¨è¯·æ±‚ä¸­å¯ä»¥å¸¦ä¸Šç‰ˆæœ¬å·, åˆ†æ™®é€š/æ•°æ®åº“è¿ç§»ä¸¤ç§æƒ…å†µ. è¯¦æƒ…è§å®˜ç½‘[æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/optimistic-concurrency-control.html)
- `_shards` æ­¤å˜æ›´å½±å“çš„åˆ†ç‰‡. ä¸Šè¿°å˜æ›´ESå®ä¾‹é‡Œå…±æœ‰2ä¸ªåˆ†ç‰‡, æ•°æ®æ’å…¥åˆ°äº†å…¶ä¸­1ä¸ªåˆ†ç‰‡ä¸­.

é™¤æ­¤ä¹‹å¤–ä¸€äº›å…¶ä»–æ³¨æ„ç‚¹

- ESçš„documentæ˜¯ä¸å¯å˜çš„(immutable)çš„, ä¹Ÿå°±æ˜¯è¯´è¦æƒ³æ›´æ–°ä¸€ä¸ªdocument, ES ä¸ä¼šå»å†…å­˜/ç£ç›˜ä¸­å®šä½æ—§ document, ç„¶ååš inplace æ›´æ–°. However, ES ä¼šæŠŠå¤šä¸ª document çš„æ•°æ®å†™åœ¨ç£ç›˜é‡Œçš„ä¸€ä¸ªsegment æ–‡ä»¶é‡Œ, æ¯å½“æˆ‘ä»¬æƒ³è¦æ’å…¥/æ›´æ–°/åˆ é™¤, ES åªä¼šæŠŠæ›´æ–°ä¿¡æ¯ä»¥ **append** çš„æ–¹å¼è®°å½•åœ¨Segment æ–‡ä»¶ä¸­. æ‰€ä»¥åœ¨ä¸€ä¸ª Segment æ–‡ä»¶ä¸­, åŒä¸€ä¸ª Document çš„æ–°è€æ•°æ®æ˜¯å¹¶å­˜çš„.

    åŸå› å’Œ ES çš„åº•å±‚ Apache Lucene çš„å®ç°æœ‰ç‚¹å…³ç³», è¿™ä¹ˆè®¾è®¡ç¬¬ä¸€çœ¼çœ‹ä¸Šå»å¯èƒ½éš¾ä»¥ç†è§£, ä½†æ˜¯åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä½åˆ°æ—§ document å¹¶æ›´æ–°ååˆ†çš„ä½æ•ˆç‡ (å®šä½ + ä¸Šé”), å¦‚æœ document æ˜¯ immutable çš„è¯æ–° document å°±å¯ä»¥ç›´æ¥å†™åˆ°æ–°segment é‡Œé¢ä¸ç”¨ç®¡æ—§çš„äº†. è¿˜æœ‰ç¼“å­˜ä¼˜åŠ¿, è¿™ä¸ªä¼˜åŒ–ç”±äºæ˜¯ ES åšåˆ°é«˜é€Ÿæœç´¢çš„é‡ç‚¹åŸå› , ç¬”è€…ä¼šåœ¨ä¸‹æ–‡ç»†è°ˆ.

- åˆ é™¤çš„è¯è¯­æ³•ç±»ä¼¼, ES ä¼šæŠŠéœ€è¦åˆ é™¤ Document çš„ Document ID è®°å½•åˆ°ä¸€ä¸ªä¸“é—¨å­˜å‚¨å¤±æ•ˆæ•°æ®æ–‡ä»¶åå†å¼‚æ­¥åˆ é™¤ (å³tombstone), å¾ˆå¸¸è§çš„è®¾è®¡æ–¹æ³•, è¿™è¾¹ä¸å†èµ˜è¿°

> Simple Search

åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­, æˆ‘ä»¬ä¼šåœ¨ `megacorp` è¿™ä¸ª ES Index ä¸­çš„ `employee` Type ä¸‹æœç´¢æ‰€æœ‰ `about` å­—æ®µä¸­å¸¦æœ‰ "rock climbing" çš„æ‰€æœ‰æ•°æ®

è¯·æ±‚

```bash
curl -X GET "localhost:9200/megacorp/employee/_search?pretty" 
     -H 'Content-Type: application/json' 
     -d'
        {
            "query" : {
                "match" : {
                    "about" : "rock climbing"
                }
            }
        }
        '

```

è¿”å›

```json
{
   ...

   "hits": {
      "total":      2,
      "max_score":  0.16273327,
      "hits": [
         {
            ...
            "_score":         0.16273327, 
            "_source": {
               "first_name":  "John",
               "last_name":   "Smith",
               "age":         25,
               "about":       "I love to go rock climbing",
               "interests": [ "sports", "music" ]
            }
         },
         {
            ...
            "_score":         0.016878016, 
            "_source": {
               "first_name":  "Jane",
               "last_name":   "Smith",
               "age":         32,
               "about":       "I like to collect rock albums",
               "interests": [ "music" ]
            }
         }
      ]
   }
}

```

è¿”å›æ•°æ®è¿˜æ˜¯å¾ˆç›´è§‚çš„:

- `hits` æ‰€æœ‰å‘½ä¸­äº†æœç´¢æ¡ä»¶çš„æ•°æ®
- `_score` ElasticSearch ä¼šæŠŠå‘½ä¸­äº†çš„æ•°æ®æ ¹æ®åŒ¹é…åº¦è®¡ç®—å‡ºåŒ¹é…å€¼, è¿™ä¸ªåŒ¹é…å€¼çš„è®¡ç®—é»˜è®¤çš„æ˜¯ Lucene å¹¿ä¸ºäººçŸ¥çš„ TF-IDF æ–‡æœ¬æŒ–æ˜ç®—æ³•[[Source](https://lucene.apache.org/core/4%5C_0%5C_0/core/org/apache/lucene/search/similarities/TFIDFSimilarity.html)]. å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰ Similarity ç®—æ³•, ä½†è¿™ä¸ªè¶…å‡ºæœ¬æ–‡çš„èŒƒå›´, è¿™è¾¹å°±ä¸èµ˜è¿°äº†.
- ç¬¬äºŒä¸ªè¿”å›ç»“æœä¸­çš„ `about` å­—æ®µé‡Œåªå‘½ä¸­äº† "rock climbing" ä¸­çš„ "rock" æ‰€ä»¥åŒ¹é…åˆ†ç›¸è¾ƒç¬¬ä¸€ä¸ªæ•°æ®è¾ƒä½. è¿™ä¹Ÿæ˜¯è¯´æ˜äº† ES é»˜è®¤æ˜¯å…¨æ–‡æœç´¢(Full-Text Search), ä¼šæŠŠç”¨æˆ·è¯·æ±‚çš„æ–‡æœ¬å…ˆåˆ†è¯å†æœç´¢. å¦‚æœç”¨æˆ·æƒ³è¦å¼ºåˆ¶æœç´¢æ•´ä¸ªè¯ç»„ (å³åšå­—ç¬¦ä¸²åŒ¹é…) å¯ä»¥ä½¿ç”¨ ElasticSearch Query DSL ä¸­çš„ `match_phrase` è¯­æ³•å³å¯

### 3. 1 æœºæ„åŒ–æœç´¢ & èšåˆæ“ä½œ Structured Search & Aggregation

é™¤äº†ä¸Šé¢çœ‹åˆ°çš„ä¸€äº›ç®€å•çš„CRUDæ“ä½œ, ElasticSearch è¿˜æ”¯æŒä¸€äº›ç›¸å¯¹å¤æ‚çš„ç»“æ„åŒ–æœç´¢ (ç±»ä¼¼ SQL ä¸­å¤æ‚çš„ Conditon) å’Œèšåˆæ“ä½œ. æˆ‘ä»¬ä¹Ÿå¿«é€Ÿçš„çœ‹ä¸€äº›ç®€å•çš„ä¾‹å­:

> å¤æ‚æ¡ä»¶æœç´¢ Structured Search

åœ¨è¿™ä¸ªæœç´¢è¯·æ±‚ä¸­, æˆ‘ä»¬æƒ³è¦æœç´¢ `megacorp` è¿™ä¸ª ES Index çš„ `employee` type ä¸‹æ‰€æœ‰ `last name` æ˜¯ â€œsmithâ€ å¹¶ä¸”å¹´é¾„å¤§äº 30 çš„æ•°æ®.

è¯·æ±‚

```bash
curl -X GET "localhost:9200/megacorp/employee/_search?pretty" 
     -H 'Content-Type: application/json' 
     -d'
        "query" : {
            "bool" : {
                "must" : {
                    "match" : {
                        "last_name" : "smith" 
                    }
                },
                "filter" : {
                    "range" : {
                        "age" : { "gt" : 30 } 
                    }
                }
            }
        }
        '

```

> èšåˆæ“ä½œ Aggregations

åœ¨è¿™ä¸ªèšåˆè¯·æ±‚ä¸­, æˆ‘ä»¬æƒ³è¦æ ¹æ® `interests` å­—æ®µæ¥åšèšç±»(å³SQLä¸­çš„`group by`), å¹¶è®¡ç®—å‡ºæ¥æ¯ä¸ªç±» (ESç§°ä¹‹ä¸º`bucket`) ä¸­çš„æ‰€æœ‰æ•°æ®çš„å¹³å‡å¹´é¾„, å°†ç»“æœå­˜åœ¨ `avg_age`å­—æ®µä¸­

è¯·æ±‚

```bash
curl -X GET "localhost:9200/megacorp/employee/_search?pretty" 
     -H 'Content-Type: application/json' 
     -d'
        {
            "aggs" : {
                "all_interests" : {
                    "terms" : { "field" : "interests" },
                    "aggs" : {
                        "avg_age" : {
                            "avg" : { "field" : "age" }
                        }
                    }
                }
            }
        }
        '

```

è¿”å›

```json
...
"all_interests": {
   "buckets": [
      {
         "key": "music",
         "doc_count": 2,
         "avg_age": {
            "value": 28.5
         }
      },
      {
         "key": "forestry",
         "doc_count": 1,
         "avg_age": {
            "value": 35
         }
      },
      {
         "key": "sports",
         "doc_count": 1,
         "avg_age": {
            "value": 25
         }
      }
   ]
}

```

è¿”å›ç»“æœååˆ†æ¸…æ™°æ˜ç™½, è¿™è¾¹å°±ä¸å†èµ˜è¿°.

### 3.2 æœ‰è¶£å°åŠŸèƒ½

è¿™è¾¹å’±ä»¬å†çœ‹ä¸€äº› ES ä¸€äº›æ–¹ä¾¿çš„æœ‰è¶£å°åŠŸèƒ½

> Highlight

å…³é”®è¯é«˜äº®, æœç´¢è¯·æ±‚ä¸­å¸¦ä¸Š `highlight` ES ä¼šé€šè¿‡åœ¨è¢«å‘½ä¸­çš„å…³é”®è¯å‘¨è¾¹åŠ ä¸Š`<em>`æ¥æ–¹ä¾¿å‰ç«¯å®ç°é«˜äº®.

è¯·æ±‚:

```bash
curl -X GET "localhost:9200/megacorp/employee/_search?pretty" 
     -H 'Content-Type: application/json' 
     -d'
        {
            "query" : {
                "match_phrase" : {
                    "about" : "rock climbing"
                }
            },
            "highlight": {
                "fields" : {
                    "about" : {}
                }
            }
        }
        '

```

è¿”å›:

```json
{
   ...
   "hits": {
      "total":      1,
      "max_score":  0.23013961,
      "hits": [
         {
            ...
            "_score":         0.23013961,
            "_source": {
               "first_name":  "John",
               "last_name":   "Smith",
               "age":         25,
               "about":       "I love to go rock climbing",
               "interests": [ "sports", "music" ]
            },
            "highlight": {
               "about": [
                  "I love to go <em>rock</em> <em>climbing</em>" 
               ]
            }
         }
      ]
   }
}

```

- é™¤æ­¤ä¹‹å¤–è¿˜æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢, æœç´¢è”æƒ³è¯, ä»¥åŠåœ°ç†ä½ç½®æŸ¥è¯¢ç­‰ç­‰, è¿™è¾¹å°±ä¸èµ˜è¿°äº†

## 4. åŸç† (æœ¬æ–‡æ ¸å¿ƒ)

ä»ç°åœ¨å¼€å§‹æœ¬æ–‡çš„å…³é”®æ ¸å¿ƒ, æˆ‘ä»¬ä¼šä»å®è§‚è§†è§’é€æ­¥åˆ°å¾®è§‚ä¸€æ­¥æ­¥ç†è§£ ElasticSearch æ˜¯æ€ä¹ˆåšåˆ°æ¥è¿‘å®æ—¶çš„æœç´¢çš„åŒæ—¶ç¡®ä¿äº†æ•°æ®çš„é«˜å¯ç”¨æ€§çš„.

è¿˜è®°å¾—æˆ‘ä»¬åœ¨æœ¬æ–‡ â€œSection 1 åŸºç¡€æ¦‚å¿µâ€ é€šè¿‡å’ŒRDBåšç±»æ¯”æ¥å¸¦é¢†å¤§å®¶ç²—ç•¥çš„ç†è§£äº†ä¸€äº› ElasticSearch çš„åŸºç¡€æ¦‚å¿µå—, æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå…ˆæ›´åŠ ä¸¥è°¨çš„é‡æ–°å®šä¹‰ä¹‹å‰ä»‹ç»è¿‡çš„åŸºç¡€æ¦‚å¿µ.

### 4.1 é›†ç¾¤ Cluster

- å®šä¹‰: cluster æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª node ç»„æˆçš„é›†ç¾¤, æ¯ä¸€ä¸ª node ä¸Šéƒ½è¿è¡Œç€ä¸€ä¸ª ES å®ä¾‹. ElasticSearch çš„é›†ç¾¤æ­£å¦‚å®ƒçš„åå­—æ‰€è¯´, è‡ªå¸¦å¾ˆå¥½çš„å»¶å±•æ€§ (elastic), ä¼šè‡ªåŠ¨å¤„ç†è´Ÿè½½å‡è¡¡, ä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ‰©å®¹.
- æ­£å¦‚ä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿ, ä¸ºäº†ç¡®ä¿æ¯ä¸ªæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®çš„ä¸€è‡´æ€§ (consistency) å’Œå†…éƒ¨çŠ¶æ€çš„å…±è¯†(consensus), ElasticSearch ä¹Ÿæœ‰ master node çš„å®šä¹‰.
    - master node çš„å”¯ä¸€èŒè´£æ˜¯ç”¨äºç®¡ç†é›†ç¾¤çº§åˆ«çš„æ“ä½œ, æ¯”å¦‚åˆ›å»ºåˆ é™¤ä¸€ä¸ªES index, æˆ–åœ¨é›†ç¾¤ä¸­æ·»åŠ /åˆ é™¤ä¸€ä¸ª node (èŒè´£ç±»ä¼¼å¤§å®¶ç†Ÿæ‚‰çš„ Consul ä¸­çš„ server å’Œ agent çš„å…³ç³»), master node ä¸å‚ä¸ document çº§åˆ«çš„æ”¹åŠ¨. æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥æ˜¯ master, å½“ master node æœåŠ¡æŒ‚æ‰äº†, ä¼šé€šè¿‡ Paxos ç®—æ³•è¿›è¡Œ leader election. Paxos ç®—æ³•ç”±äºæ¯”è¾ƒå¤æ‚, æˆ‘è¿™è¾¹ä¼šå¦å¤–å†™ä¸€éæ–‡ç« å°† Paxos å’Œ Raft åè®®ä¸€å¹¶åšä¸ªä»‹ç»åˆ†æ.
    - å› ä¸ºæ¯ä¸€ä¸ª node éƒ½æ˜¯ä¸€ä¸ª ES å®ä¾‹, ç”¨æˆ·å¯ä»¥å‘ä»»ä½•ä¸€ä¸ª node å‘é€è¯·æ±‚, è¢«è¯·æ±‚çš„ node ä¼šè¿›è¡ŒæœåŠ¡å‘ç°, å®šä½åˆ°ç›®æ ‡æ•°æ®æ‰€åœ¨ node, å¹¶å¯¹æ•°æ®è¿›è¡Œå¤„ç†è¿”å›ç»™ç”¨æˆ·. å…·ä½“æµç¨‹ä¸‹æ–‡ä¼šæœ‰ä»‹ç». æ³¨æ„ master node ä¸å‚ä¸ä¸Šè¿°æ“ä½œ.

### 4.2 ES Index

- å®šä¹‰: index æ˜¯ ES å­˜å‚¨æ•°æ®çš„åœ°æ–¹, è§’è‰²ç±»ä¼¼äºRDBä¸­çš„ database, å®é™…ä¸Š, ES Indexæ˜¯ä¸€ä¸ªæŒ‡å‘å¤šä¸ªç‰©ç†åˆ†ç‰‡ (shard) çš„ logic namespace, æ¯ä¸€ä¸ªåˆ†ç‰‡éƒ½æ˜¯ä¸€ä¸ª Apache Lucene çš„å®ä¾‹ (å³ä¸€ä¸ªç‹¬ç«‹çš„æœç´¢å¼•æ“), ç”¨æˆ·çš„ document éƒ½ä¼šåœ¨åˆ†ç‰‡ä¸Šå­˜å‚¨, ä½†ç”¨æˆ·ä¸ä¼šç›´æ¥å’Œåˆ†ç‰‡äº¤äº’, ç”±ES indexè´Ÿè´£ç”¨æˆ·äº¤äº’ä»¥åŠè´Ÿè½½å‡è¡¡.
- è¿™è¾¹å…³ç³»å¯èƒ½æœ‰ç‚¹ä¹±, ç¬”è€…è¿™è¾¹ç”»äº†ä¸ªå›¾æ¥ç»™å¤§å®¶æ¢³ç†ä¸€ä¸‹:

    ![image/1611887977528_cd2052449c69156ab6ed2a80ba4f6ad0.png](image/1611887977528_cd2052449c69156ab6ed2a80ba4f6ad0.png)

- æ•°æ® document å­˜åœ¨ç‰©ç†åˆ†ç‰‡ shard é‡Œé¢
- æ¯ä¸ª shard åˆ†ç‰‡åªè¢«ä¸€ä¸ª node æ¥ç®¡è¾–
- æ¯ä¸ª node å­˜å‚¨ç€ä¸€ä¸ªæˆ–å¤šä¸ª shard
- ç”¨æˆ·ç›´æ¥å‘é€è¯·æ±‚åˆ°ä»»æ„ä¸€ä¸ª node ä¸Š, è¿™ä¸ª node è´Ÿè´£å®šä½è¿™ä¸ªæ•°æ®è¯¥äº¤ç»™å“ªä¸ª node æ¥å¤„ç†
- æ¥å—è¯·æ±‚çš„ node è´Ÿè´£æœåŠ¡å‘ç°ä»¥åŠè½¬å‘è¯·æ±‚åˆ°å¤„ç†æ•°æ®çš„ node ä¸Š
- shard åˆ†ç‰‡åˆ†ä¸ºä¸¤ç§: ä¸»åˆ†ç‰‡ (primiary shard) å’Œå‰¯æœ¬åˆ†ç‰‡ (replica shard), ä¸»åˆ†ç‰‡ä¸ªæ•°åœ¨åˆ›å»º index æ—¶å€™å°±å›ºå®šäº†, ä½†æ˜¯æ¯ä¸€ä¸ªä¸»åˆ†ç‰‡æ‹¥æœ‰çš„å‰¯æœ¬åˆ†ç‰‡ä¸ªæ•°æ˜¯å¯ä»¥åŠ¨æ€é…ç½®çš„.
- [é—®] è¿™è¾¹å¤§å®¶å¯èƒ½å°±æœ‰ç–‘é—®äº†. è¯·æ±‚æ—¢ç„¶æ˜¯ç›´æ¥æ‰“åˆ°ä»»æ„ä¸€ä¸ª node, å†™å…¥æ—¶æ˜¯å¦‚ä½•ç¡®å®š document è¯¥å†™åˆ°å“ªä¸ª shard ä¸­å‘¢?

    [ç­”] ElasticSearch è¿™è¾¹ç”¨äº†ä¸€ä¸ªå¾ˆæ™®éçš„æ•°æ®åº“å†å¹³è¡¡ (rebalancing) è®¾è®¡æ¨¡å¼: `hash % N`

    æ¯ä¸ªå†™å…¥ ElasticSearch çš„ Document éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„Document ID, å¯èƒ½æ˜¯ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™å£°æ˜çš„ä¹Ÿå¯èƒ½æ˜¯ ES è‡ªåŠ¨ç»™æ•°æ®ç”Ÿæˆçš„. å½“å†™å…¥æˆ–è€…æ ¹æ® Doucment ID æŸ¥è¯¢æ•°æ®æ—¶, ES ä¼šæ ¹æ®ä¸‹é¢è¿™ä¸ªå¾ˆç®€å•çš„å…¬å¼æ¥å®šä½è¿™ä¸ª Documnt å¯¹åº”çš„ shard.

    ```
    shard # = hash(document_id) % number_of_primary_shards
    ```

    å› æ­¤, åªéœ€ä¿è¯ hash å‡½æ•°æ˜¯ uniform çš„[[ä»€ä¹ˆæ˜¯ uniform](https://en.wikipedia.org/wiki/SUHA_%5C(computer_science%5C))], æ¯ä¸ªshardçš„è´Ÿè½½éƒ½æ˜¯å‡è¡¡çš„äº†, è¿™ä¹Ÿæ˜¯primary shard çš„ä¸ªæ•°åªèƒ½åœ¨åˆ›å»º index æ—¶å®šä¹‰, ä¹‹åä¸èƒ½æ”¹å˜çš„åŸå› .

- ElasticSearch åœ¨æœ€åˆè®¾è®¡æ—¶ä¸»è¦ç›®æ ‡ä¹‹ä¸€å°±æ˜¯çµæ´»çš„æ°´å¹³å»¶å±•æ€§, ES é’ˆå¯¹æŸä¸ª index æ°´å¹³æ‰©å®¹æ˜¯ååˆ†æ–¹ä¾¿çš„. å’±ä»¬æ¥çœ‹ä¸ªä¾‹å­:
    - indexæœ‰ä¸‰ä¸ªä¸»åˆ†ç‰‡(P0, P1, P2)æ¯ä¸ªä¸»åˆ†ç‰‡æœ‰ä¸€ä¸ªå‰¯æœ¬åˆ†ç‰‡(R0, R1, R2)

        ![image/1611887977340_1a39c66a60f8fa1c559b52508b69882a.png](image/1611887977340_1a39c66a60f8fa1c559b52508b69882a.png)

    - æ·»åŠ ä¸€ä¸ªnodeå (ES æ²¡æœ‰ Consul é‚£ä¹ˆæ–¹ä¾¿, æ–°åŠ ä¸€ä¸ª node éœ€è¦æ‰‹åŠ¨åœ¨configæ–‡ä»¶é…ç½® IP ç­‰ä¿¡æ¯)

        ![image/1611887977335_992048f3c2545fcb6f3b9312b28ea5b2.png](image/1611887977335_992048f3c2545fcb6f3b9312b28ea5b2.png)

    - æˆ–è€…åŠ¨æ€é…ç½®, æŠŠæ¯ä¸ªä¸»åˆ†ç‰‡å¯¹åº”çš„å‰¯æœ¬åˆ†ç‰‡ä¸ªæ•°ä»1æå‡åˆ°2. ES ä¼šç¡®ä¿æ¯ä¸ª node ä¸ä¼šæ‹¥æœ‰é‡å¤çš„ Shard ä»¥é˜²æ­¢å…¶ä¸­ä¸€ä¸ªæœåŠ¡æŒ‚æ‰å¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸å¯ç”¨.

        ![image/1611887977438_8a0662bbdd25bd9dcd105da8ea575cdd.png](image/1611887977438_8a0662bbdd25bd9dcd105da8ea575cdd.png)

- [é—®] ä½ å¯èƒ½æœ‰ç–‘é—®äº†, å½“æ–°åŠ äº†ä¸€ä¸ª node å ES å¦‚ä½•è¿›è¡ŒæœåŠ¡å‘ç°çš„

    [ç­”] ES ä¼šè¯»å–é…ç½®ä¿¡æ¯, é€šè¿‡ç»å…¸çš„æµè¡Œç—…åè®® (Gossip Procotol) è¿›è¡ŒæœåŠ¡å‘ç°ä»¥åŠæ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„å¥åº·çŠ¶æ€, è¯·æ±‚å‘é€æ”¯æŒå•æ’­ (unicast) ä»¥åŠç»„æ’­ (muticast)

- [é—®] æˆ‘çŒœå¤§å®¶è¿˜ä¼šå¥½å¥‡ ES åœ¨æ–°åŠ /åˆ é™¤ä¸€ä¸ª node åæ˜¯æ€ä¹ˆé‡æ–°åˆ†é… nodes ä¸­çš„ shards æ¥ä¿æŠ¤æ•°æ®å¯ç”¨æ€§ä»¥åŠè´Ÿè½½å‡è¡¡çš„?

    [ç¬”è€…åé—®] è¿™å…¶å®æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ç®—æ³•é¢˜, çœ‹çœ‹ä½ èƒ½ä¸èƒ½ç”¨è´ªå¿ƒç®—æ³•è‡ªå·±å†™ä¸ªSolutionå‡ºæ¥?

- [é—®] ä¸»åˆ†ç‰‡ (primary shard) å’Œå‰¯æœ¬åˆ†ç‰‡ (replica shard) ä¹‹é—´æ˜¯æ€ä¹ˆäº¤äº’çš„å‘¢?

    [ç­”] å’±ä»¬å…ˆçœ‹ä¸‹åŸºç¡€çš„CRUD:

    å¤§è‡´æ€è·¯æ˜¯: **å…ˆæ›´æ–° primary shard, åŒæ­¥æ›´æ–°replica**

    ![image/1611887977356_135608a2eccd5f512eaa7bf881f746e3.png](image/1611887977356_135608a2eccd5f512eaa7bf881f746e3.png)

    1. ç”¨æˆ·å‘é€ CRUD è¯·æ±‚åˆ° node 1
    2. node 1 è®¡ç®— Document IDçš„ hash å‘ç°è¿™ä¸ªæ–‡æ¡£å­˜å‚¨åœ¨ shard 0 ä¸Š, è€Œ shard 0 çš„ä¸»åˆ†ç‰‡ç›®å‰å­˜å‚¨åœ¨ node 3 ä¸Šé¢
    3. node 1 å°†è¯·æ±‚è½¬å‘åˆ° node 3, node 3 å¯¹æ–‡æ¡£è¿›è¡Œç›¸å…³æ•°æ®æ“ä½œ
    4. æ¯æ¬¡å¯¹æ•°æ®çš„æ›´æ–°ä¼šå…ˆå†™å…¥ä¸»åˆ†ç‰‡, å†åŒæ­¥åˆ°å‰¯æœ¬. å¦‚æœæ•°æ® node 1 æ›´æ–°æˆåŠŸ, node 3 ä¼šå¹¶è¡Œè½¬å‘æ›´æ–°è¯·æ±‚åˆ° node 1, node 2. å¾… node 1, node 2 éƒ½æ›´æ–°å®Œæ¯•å, node 3 å‘ç”¨æˆ·è¿”å›è¯·æ±‚æ‰§è¡Œç»“æœ.

    æ³¨æ„ç‚¹:

    - è¿™è¾¹ ES ä¹Ÿæ”¯æŒå°†è¯¥æµç¨‹é…ç½®æˆå¼‚æ­¥, ä¸ç­‰æ‰€æœ‰ node å¤„ç†å®Œè¯·æ±‚åªè¦ node 3 å®Œæˆå°±å‘ç”¨æˆ·è¿”å›. è¿™æ˜¯ç³»ç»Ÿè®¾è®¡ä¸­å¾ˆç»å…¸çš„ trade-off äº†, ä¸è¿‡ç¬”è€…ä»¥åŠå®˜æ–¹éƒ½ä¸å»ºè®®é…ç½®æˆå¼‚æ­¥, æ•°æ®ä¸€è‡´æ€§éš¾ä»¥ä¿éšœæ˜¯ä¸€æ–¹é¢, è®¾ç½®æˆå¼‚æ­¥ ES ä¸èƒ½å¤Ÿå®ç° **Back Pressure**, å‡å¦‚æœ‰ä¸€ä¸ªè¯·æ±‚æ‰§è¡Œæ—¶é—´é•¿å æœ‰èµ„æºå¤š, è¿‡æ—©è¿”å›è¯·æ±‚å¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·å¯¹æœåŠ¡å™¨èƒ½åŠ›è¿‡äºä¹è§‚, æ‰“ä¸€å †è¯·æ±‚è¿‡æ¥, é€ æˆè¯·æ±‚è¿‡å¤š, ç¼“å­˜å †ç§¯, æœåŠ¡å™¨è¿‡è½½. å¦‚æœè®¾ç½®æˆåŒæ­¥è¿›è¡Œ, ES æœåŠ¡å™¨ä¼šåœ¨æœåŠ¡å™¨é«˜è´Ÿè½½æ—¶è¿”å› `503`
    - å’Œæ‰€æœ‰åˆ†å¸ƒå¼ç³»ç»Ÿä¸€æ ·, æ•°æ®ä¸€è‡´æ€§é¢—ç²’åº¦æ˜¯å¯é…ç½®çš„:
        - one: åªè¦ä¸€ä¸ª node æˆåŠŸå°±å‘ç”¨æˆ·è¿”å› [ä¸å»ºè®®]
        - all: æ‰€æœ‰çš„ node éƒ½æˆåŠŸåæ‰è¿”å›
        - å¤§å¤šæ•°: `quorum` ä¸ª node æˆåŠŸåè¿”å›ç»™ç”¨æˆ·.

            åˆ†å¸ƒå¼é¢†åŸŸçš„ç»å…¸å…¬å¼äº†:

            ```
            quorum = int( (primary + number_of_replicas) / 2 ) + 1
            ```

    è¯»å– Document:

    ![image/1611887977418_48e639f064d486db8336b6599b9c8b9f_(1).png](image/1611887977418_48e639f064d486db8336b6599b9c8b9f_(1).png)

    - å› ä¸ºå†™å…¥æ—¶æˆ‘ä»¬ç¡®ä¿äº†æ•°æ®ä¸€è‡´æ€§, ä¸ç®¡ä¸»åˆ†ç‰‡è¿˜æ˜¯å‰¯æœ¬åˆ†ç‰‡éƒ½å¯ä»¥ç”¨äºè¯»å–æ•°æ®, ESé€šè¿‡ Round-Robin æ¥å‡è¡¡è¯·æ±‚è´Ÿè½½
    - å¦‚æœä¹‹å‰é…ç½®äº†å¼‚æ­¥å†™å…¥å¯èƒ½ä¼šä¸»åˆ†ç‰‡æœ‰æ•°æ®è€Œå‰¯æœ¬åˆ†ç‰‡æ¥ä¸åŠæ‹·è´, å¯¼è‡´æ¥å£è¿”å›ä¸ä¸€è‡´çš„æƒ…å†µ

### 4.3 æœç´¢ Search

æœç´¢ä¸»è¦åˆ†å››å¤§å—: Mapping, Analysis, Query DSL, ä»¥åŠæ¥è¿‘å®æ—¶çš„æœç´¢é€Ÿåº¦ (Near-real-time)

*Analysis*: ä¸»è¦è´Ÿè´£å¯¹è¯·æ±‚æ–‡æœ¬ä»¥åŠæ’å…¥æ•°æ®æ–‡æœ¬è¿›è¡Œä¸€äº›åˆ†è¯ (Tokenization), ç±»å‹è¯†åˆ« (NER), ä»¥åŠæƒé‡è®¡ç®— (TF-IDF)ç­‰, å› ä¸ºä¸»è¦æ¶‰åŠ NLP é¢†åŸŸçŸ¥è¯†, è¿™è¾¹å°±å…ˆè·³è¿‡ä¸è®²äº†.

*Query DSL:* å³ ES æœç´¢è¯·æ±‚ä¸­çš„ä¸€äº›è¯­æ³•, çœ‹å®˜æ–¹æ–‡æ¡£å³å¯ä¹Ÿæ²¡å•¥å¥½è¯´çš„, è¿™è¾¹å°±è·³è¿‡äº†

*Mapping:* ES éœ€è¦å¯¹æ’å…¥çš„æ•°æ®è¿›è¡Œ Schema çº¦æŸ, mapping æ–‡ä»¶å­˜æ”¾ç€å®šä¹‰æ•°æ®æ ¼å¼ç±»å‹çš„ schema. è¯­æ³•æ ¼å¼å’Œå¾ˆå¤š NoSQL Database ä¸­çš„ JSON Schema å®šä¹‰åŠå…¶ç›¸ä¼¼. ESåŒæ ·éœ€è¦éœ€è¦è¿™ä¹ˆä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥ç¡®å®šå¦‚ä½•å»ºç«‹æŸä¸ªå­—æ®µçš„å€’æ’ç´¢å¼•.

å½“æˆ‘ä»¬ insert ä¸€ä¸ª document çš„æ—¶å€™, ES çš„ è¯­ä¹‰åˆ†æå™¨ (analyzer) ä¼šæ ¹æ®å­—æ®µå†…å®¹è‡ªåŠ¨åŠ¨æ€çš„ç»™æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª mapping æ–‡ä»¶, ä¸‹é¢æ˜¯ä¸€ä¸ª mapping æ–‡ä»¶ä¾‹å­:

```json
{
    "gb": {
        "mappings": {
             "tweet": {
                "properties": {
                   "date": {
                      "type": "date",
                      "format": "dateOptionalTime"
                   },
                   "name": {
                       "type": "string"
                   },
                   "tweet": {
                      "type": "string"
                   },
                   "user_id": {
                      "type": "long"
                   }
                } 
            }
        } 
    }
}

```

ä½†æ˜¯å®é™…ä¸Šè‡ªåŠ¨ç”Ÿæˆçš„ mapping æ–‡ä»¶ä¼šæœ‰å¾ˆå¤šå‘, åŸºæœ¬ä¸Šè¦è‡ªå·±å®šä¹‰ mapping æ–‡ä»¶ä¼šæ›´å®‰å…¨, ä¸è¿‡mapping æ–‡ä»¶æœ¬èº«å‘éå¸¸éå¸¸å¤š, å’±ä»¬å­—èŠ‚æœ‰ä¸ªé¿å‘æŒ‡å—, å»ºè®®å¤§å®¶çœ‹ä¸€ä¸‹: [[æ±‡æ€»] ES ä½¿ç”¨è¿‡ç¨‹ä¸­åº”å°½é‡é¿å…çš„ é«˜å±æ“ä½œ](https://bytedance.feishu.cn/docs/doccnxcYr4dLOVkMc1troUIbZWc#)

ç¬”è€…åœ¨æœ¬æ–‡ç€é‡å’Œå¤§å®¶è®¨è®º ES å¦‚ä½•åšåˆ°**æ¥è¿‘å®æ—¶çš„åˆ†å¸ƒå¼æŸ¥æ‰¾**

- ES æ˜¯å¦‚ä½•åšåˆ°æ¥è¿‘å®æ—¶çš„åˆ†å¸ƒå¼æŸ¥æ‰¾çš„å‘¢? (Distributed Search Execution)

    å¤æ‚ç‚¹:

    - å¯¹ä»»ä½•ä¸€ä¸ªæœç´¢è¯·æ±‚æ‰€åŒ¹é…çš„ç»“æœæœªçŸ¥, æ‰€ä»¥æ¯æ¬¡æœç´¢å¿…é¡»è¦æŸ¥è¯¢æ‰€æœ‰çš„ shards
    - æœç´¢åŒ¹é…ç»“æœå¤šæ ·çš„, å¯èƒ½ document ä¹‹é—´éƒ½æœ‰ä¸åŒçš„ mapping, è¿˜éœ€åˆ†æåŒ¹é…åº¦å¯¹æœç´¢ç»“æœæ‰“åˆ†æ’åº, ä»¥åŠåˆ†é¡µä¹‹ç±»çš„.

    ES æå‡ºçš„ Solution: åˆ†ä¸ºä¸¤ä¸ªå¤§é˜¶æ®µ: **Query-then-fetch**

    - Query é˜¶æ®µ

        åˆ†å¸ƒå¼æœç´¢æœ¬è´¨ä¸Šå°±æ˜¯ä»å¤šä¸ªæœåŠ¡ä¸­é€‰å– score æœ€å¤§çš„ Top-K æ•°æ® (é¢è¯•è¢«é—®çƒ‚äº†æœ‰æœ¨æœ‰). å› æ­¤ESçš„å¤§è‡´æ€è·¯ä¼šæŠŠç”¨æˆ·çš„è¯·æ±‚å¹¿æ’­åˆ°æ¯ä¸€ä¸ª shard (å¯èƒ½æ˜¯ primary ä¹Ÿå¯èƒ½æ˜¯ replica), åœ¨æ¯ä¸€ä¸ª shard ä¸Šæ‰§è¡Œquery, è®¡ç®—åŒ¹é…åº¦, æ„å»º priority queue

        ![image/1611887977427_6b4c78d96d96936be214cdb1e20370c6.png](image/1611887977427_6b4c78d96d96936be214cdb1e20370c6.png)

        1. ç”¨æˆ·å‘é€ query åˆ° node 3, node 3 ä¼šå…ˆå»ºç«‹ä¸€ä¸ªç©ºçš„ priority queue, priority queue é¢„ç•™ç©ºé—´å¤§å°å†³å®šäºåˆ†é¡µå…¥å‚, å¦‚æœæ²¡æœ‰å…¥å‚åˆ†é¡µå¤§å°çš„è¯, ES ä¼šé»˜è®¤è®¾ç½® `1000`
        2. node 3 æŠŠ query é€šè¿‡ round-robin æ–¹å¼è½¬å‘åˆ°å…¶ä»–ä¸¤ä¸ª node çš„æ‰€æœ‰ shard ä¸Š (åŒ…æ‹¬å‰¯æœ¬åˆ†ç‰‡), è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ replica è¶Šå¤šå¯ä»¥å¢åŠ  search çš„ååçš„åŸå› , æˆ‘ä»¬å¯ä»¥è®© node 1 åœ¨ shard 1 çš„ä¸»åˆ†ç‰‡ä¸Šåšå‰ 1000 ä¸ªæ•°æ®æœç´¢, åœ¨ node 2 ä¸Š shard 1 çš„å‰¯æœ¬åˆ†ç‰‡ä¸Šåšå¯¹ç¬¬ 1000-2000 ä¸ªæ•°æ®çš„æœç´¢, å¤šçº¿ç¨‹çš„å¤„ç†æœç´¢.
        3. æ¯ä¸ª shard åœ¨æœ¬åœ°æ‰§è¡Œ query æŸ¥è¯¢, å°†åŒ¹é…åˆ°çš„ Document ID æ ¹æ®åŒ¹é…åº¦å­˜åœ¨äº†æ¯ä¸ª node æœ¬åœ°çš„ä¸€ä¸ª prioirty queue ä¸Š, å¹¶å°†ç»“æœè¿”å›ç»™ node 3
        4. node 3 æ ¹æ®ä»æ¯ä¸ª node ä¸Šæ‹¿åˆ°çš„æœ€ç»ˆçš„ Document IDs å’ŒåŒ¹é…åº¦ scores, æŠŠæ‰€æœ‰ Document IDs è¿›è¡Œæœ€ç»ˆæ’åº

        å¦‚æœæƒ³ä¸€ä¸ª query æŸ¥è¯¢å¤šä¸ª index, æµç¨‹ä¸Šå’Œä¸Šè¿°ä¸€æ¨¡ä¸€æ ·, è¿˜è®°å¾— ES Index çš„å®šä¹‰å—? æ¯ä¸ªES Index æ˜¯æŒ‡å‘ç‰©ç†åˆ†ç‰‡åº”ç”¨å±‚çš„çš„ logic namespace. å› æ­¤ç†è®ºä¸Šæ¥è¯´, å¤š index æŸ¥è¯¢æœ¬è´¨ä¸Šå°±æ˜¯ shard æ•°æ›´å¤šäº†è€Œå·²

    - Fetché˜¶æ®µ

        åœ¨Queryé˜¶æ®µæˆ‘ä»¬æ‹¿åˆ°äº†æœ€ç»ˆç»“æœçš„ Document IDs, æˆ‘ä»¬å†é€šè¿‡è¿™äº› IDs æŠ“å–æ–‡æ¡£çš„æ•°æ®, åšä¸€äº›åç½®æ•°æ®å¤„ç†, è¿”å›ç»™ç”¨æˆ·

        ![image/1611887977291_48a4261512fd50a3bde69b2c060e7a72.png](image/1611887977291_48a4261512fd50a3bde69b2c060e7a72.png)

        1. node 3 æ ¹æ® Document IDs ä»¥åŠåˆ†é¡µæ•°æ®å‘å…¶ä»– nodes ä»¥ round-robin æ–¹å¼å‘é€ GET è¯·æ±‚
        2. æ ¹æ® Document IDs è®¡ç®— hash æ¥å®šä½ shard, å†å®šä½æ•°æ®. å¦‚æœé…ç½®äº†çš„è¯, ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå¯¹ç»“æœåšä¸€æ¬¡äºŒåŠ å·¥ (æ¯”å¦‚ä¹‹å‰æåˆ°çš„å…³é”®è¯é«˜äº®), å®Œæˆåå°† Document æ•°æ®è¿”å›è‡³ node 3
        3. node 3 è¿™è¾¹ç­‰æ‰€æœ‰çš„è¯·æ±‚è¿”å›ä¹‹å, å°†ç»“æœæ•´åˆ, è¿”å›è‡³ç”¨æˆ·

    è¿™è¾¹ç¬”è€…å¸¦é¢†å¤§å®¶å­¦ä¹ äº† ES å¦‚ä½•é€šè¿‡è®¾è®¡ Query-then-Fetch æ¨¡å¼æ¥åšåˆ°æ¯æ¬¡æœç´¢è¯·æ±‚çš„è´Ÿè½½ç»å¯¹å‡è¡¡åˆ°æ¯ä¸€ä¸ªæœåŠ¡å™¨, å¹¶ä¸”é€šè¿‡å¹¿æ’­è¯·æ±‚åˆ° replica æ¥æœ€å¤§åŒ–æœç´¢å¤„ç†çš„å¹¶å‘æ€§

    **æ³¨æ„:** å› ä¸ºè¯·æ±‚æ˜¯ round robin, å¦‚æœä¸¤ä¸ª document æœ€åè®¡ç®—å‡ºæ¥çš„åŒ¹é…å€¼ score ä¸€æ‘¸ä¸€æ ·, è€Œæˆ‘ä»¬åˆæ˜¯æ ¹æ® score æ¥è¿›è¡Œæ’åº, å¾ˆå¯èƒ½ä¼šå¯¼è‡´ç›¸åŒçš„è¯·æ±‚, æ¯æ¬¡è¿™ä¸¤ä¸ªæœ‰ç›¸åŒ score çš„ document è¿”å›çš„é¡ºåºä¸ä¸€æ ·, ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, ES æä¾›äº† `preference` å‚æ•° (ä¸€èˆ¬é…ç½®ä¸ºç”¨æˆ·å½“å‰çš„ session ID), åœ¨ç¬¬ä¸€æ¬¡æœç´¢å, ES ä¼šè®°å½•æ­¤æ¬¡è¯·æ±‚ Shard çš„é¡ºåºä»¥åŠä¸€äº›æœç´¢å‚æ•°åˆ°ç¼“å­˜, ä»¥ `preference` å‚æ•°ä¸º key. è¿™æ ·æœªæ¥æœç´¢ä¿è¯åŒä¸€ä¸ªç”¨æˆ·æ¯æ¬¡è¯·æ±‚æ—¶ ES è®¿é—® shard çš„é¡ºåºå§‹ç»ˆæ˜¯ä¸€è‡´çš„.

- 4.3 æ›´æ·±ä¸€ç‚¹, ä¸ºä»€ä¹ˆèƒ½ **near real-time**

    å®é™…ä¸Š, ES å¯¹ä¸ºäº†åšåˆ° near-real-time æœç´¢åšå‡ºçš„ä¼˜åŒ–è¿œä¸æ­¢è¿™äº›. ç¬”è€…åœ¨è¿™ä¸ª section ä¼šå¸¦å¤§å®¶å¾€åº•å±‚æŒ–ä¸€æŒ–. è¿˜è®°å¾—ç¬”è€…åœ¨ Section 3 å’Œå¤§å®¶å¿«é€Ÿæäº†ä¸€ä¸‹ ES çš„ Document æ˜¯ Immutable çš„å—?

    > ESçš„documentæ˜¯ä¸å¯å˜çš„(immutable)çš„, ä¹Ÿå°±æ˜¯è¯´è¦æƒ³æ›´æ–°ä¸€ä¸ªdocument, ES ä¸ä¼šå»å†…å­˜/ç£ç›˜ä¸­å®šä½æ—§ document, ç„¶ååš inplace æ›´æ–°. However, ES ä¼šæŠŠå¤šä¸ª document çš„æ•°æ®å†™åœ¨ç£ç›˜é‡Œçš„ä¸€ä¸ªsegment æ–‡ä»¶é‡Œ, æ¯å½“æˆ‘ä»¬æƒ³è¦æ’å…¥/æ›´æ–°/åˆ é™¤, ES åªä¼šæŠŠæ›´æ–°ä¿¡æ¯ä»¥ append çš„æ–¹å¼è®°å½•åœ¨Segment æ–‡ä»¶ä¸­. æ‰€ä»¥åœ¨ä¸€ä¸ª Segment æ–‡ä»¶ä¸­, åŒä¸€ä¸ª Document çš„æ–°è€æ•°æ®æ˜¯å¹¶å­˜çš„.

    > åŸå› å’Œ ES çš„åº•å±‚ Apache Lucene çš„å®ç°æœ‰ç‚¹å…³ç³», è¿™ä¹ˆè®¾è®¡ç¬¬ä¸€çœ¼çœ‹ä¸Šå»å¯èƒ½éš¾ä»¥ç†è§£, ä½†æ˜¯åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä½åˆ°æ—§ document å¹¶æ›´æ–°ååˆ†çš„ä½æ•ˆç‡ (å®šä½ + ä¸Šé”), å¦‚æœ document æ˜¯ immutable çš„è¯æ–° document å°±å¯ä»¥ç›´æ¥å†™åˆ°æ–°segment é‡Œé¢ä¸ç”¨ç®¡æ—§çš„äº†. è¿˜æœ‰ç¼“å­˜ä¼˜åŠ¿, è¿™ä¸ªä¼˜åŒ–ç”±äºæ˜¯ ES åšåˆ°é«˜é€Ÿæœç´¢çš„é‡ç‚¹åŸå› , ç¬”è€…ä¼šåœ¨ä¸‹æ–‡ç»†è°ˆ.

    è¿™ä¸ªå…¶å®æ˜¯ä¸€ä¸ªå¾ˆç»å…¸çš„æ•°æ®å­˜å‚¨çš„æ•°æ®ç»“æ„: **LSM Tree** ( Log-structured Merge Tree) å’Œ **SSTable** (Sorted String Table). å¾ˆå¤šå…¨çƒè‘—åçš„æ•°æ®å­˜å‚¨å¼•æ“, æ¯”å¦‚ Google çš„ LevelDB å’Œ BigTable, Facebook çš„ Cassandra, ä»¥åŠä¼—æ‰€å‘¨çŸ¥çš„ SQLite, åº•å±‚éƒ½æ˜¯ LSM-Tree, è€Œä¸æ˜¯å­¦æ ¡é‡Œé¢ç»å¸¸å­¦åˆ°çš„ B-Tree.

    è¿™è¾¹ç¬”è€…å¿«é€Ÿç®€æ´çš„ç»™å¤§å®¶å…¥ä¸€ä¸‹é—¨ LSM Tree, å¦‚æœå¤§å®¶æƒ³æ›´æ·±å…¥çš„ç†è§£ä¸€ä¸‹ LSM, ç¬”è€…æœ€è¿‘é˜…è¯»ç¥ä¹¦ã€ŠDesign Data Intensive Applicationã€‹è®°å½•çš„[éšç¬”](https://www.notion.so/Design-Data-Intensive-Application-73dcecac532f4d94bd1082aa56c5b9a7)å†…æœ‰éå¸¸è¯¦ç»†çš„LSM Treeä»‹ç»ä»¥åŠå’Œ B-Tree çš„æ¯”è¾ƒåˆ†æ. æˆ–è€…å¤§å®¶æœ‰æ—¶é—´éå¸¸æ¨èç›´æ¥è¯» Google çš„ BigTable [è®ºæ–‡](https://research.google/pubs/pub27898/), è¿™ç¯‡è®ºæ–‡ä¸ä½†æå‡ºäº†æ•°æ®å­˜å‚¨çš„ä¼˜åŒ–, è€Œä¸”å¯¹å½“ä»Šå¾ˆå¤š OLAP ä¸­ Column-Oriented Database è¯ç”Ÿäº§ç”Ÿäº†æ·±è¿œå½±å“.

    SSTable ç»“æ„å›¾:

    ![image/1611887977358_7403f4910fb221024b9ec275048ff10a.png](image/1611887977358_7403f4910fb221024b9ec275048ff10a.png)

    æ•´ä½“ç»“æ„åˆ†ä¸ºå†…å­˜ä¸­çš„ **Memtable** å­˜å‚¨ç€ Key-Value Pair å’Œ ç£ç›˜ä¸­å­˜æ”¾å®Œæ•´æ•°æ®çš„ **Segment** æ–‡ä»¶

    - **Memtable**: Key æ˜¯ String ä¸”æ ¹æ® String çš„å€¼ä¼šè¿›è¡Œæ’åº, Value æ˜¯åœ¨ç£ç›˜ä¸­å¯¹åº”å­˜æ”¾æ•°æ®çš„ Segment æ–‡ä»¶æŒ‡é’ˆä»¥åŠ byte offset. ES ä¼šæ ¹æ®è¾“å…¥çš„æ–‡æ¡£è¿›è¡Œåˆ†è¯, ç„¶åå¯¹æ¯ä¸ªè¯å»ºç«‹å€’æ’, æ‰€ä»¥å¯¹ ES æ¥è¯´, å†…å­˜ä¸­çš„ Key å­˜å‚¨çš„å°±æ˜¯å»ºç«‹å€’æ’çš„å•è¯, Value å­˜å‚¨ç€æŒ‡å‘ Segment æ–‡ä»¶çš„æŒ‡é’ˆæ•°ç»„æ¥åš Secondary Index, æœ€å Secondary Index æŒ‡å‘ç€ç£ç›˜ä¸Šå®é™…çš„ Offset.
    - **Segment**: ES ä¼šæ ¹æ®è¾“å…¥çš„æ–‡æ¡£è¿›è¡Œåˆ†è¯, ç„¶åå¯¹æ¯ä¸ªè¯å»ºç«‹å€’æ’, æ‰€ä»¥ Segment æ–‡ä»¶ä¸­å­˜å‚¨çš„å°±æ˜¯å»ºç«‹ç´¢å¼•çš„å•è¯æ‰€å­˜åœ¨çš„ Document IDs çš„ Posting List.

    åœ¨ LSM Tree ä¸­, æ•°æ®çš„å†™å…¥å’Œæ›´æ–°éƒ½æ˜¯ append-only åˆ°ä¸€ä¸ª segment æ–‡ä»¶ä¸­, å½“è¿™ä¸ª segment æ–‡ä»¶è¾¾åˆ°äº†ä¸€å®šå¤§å°, æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ†è£‚æˆæ–°çš„ Segment æ–‡ä»¶. ä¹Ÿå°±æ˜¯è¯´å‡å¦‚æˆ‘ Insert/update ä¸€ä¸ªæ–°çš„ Document åˆ° ES é‡Œé¢, ES ä¼šæŠŠ Posting List ç­‰ä¿¡æ¯ append åˆ°æœ€è¿‘ä¸€æ¬¡æ›´æ–°çš„ Segment æ–‡ä»¶åé¢. è®°å½•æœ¬æ¬¡å†™å…¥çš„ç£ç›˜ Offset ä»¥åŠæ–‡ä»¶æŒ‡é’ˆ, å†™å…¥åˆ°å†…å­˜ä¸­çš„ Memtable ä¸­. è€Œä¸æ˜¯å…ˆè¯»å– Memtable å®šä½åˆ°ç£ç›˜ä¸­å­˜å‚¨ Posting List çš„ä½ç½®ç„¶ååš Inplace æ›´æ–°. å½“ç£ç›˜ä¸­ Segment åˆ°è¾¾äº†ä¸€å®šçš„å¤§å°æˆ–è€… è¿‡äº†ä¸€å®šæ—¶é—´æ®µå ES ä¼šå°†ç£ç›˜ä¸­çš„ Segment æ–‡ä»¶åœ¨ä¸€ä¸ªåå°è¿›ç¨‹ä¸­è¿›è¡Œ Merge æ“ä½œ, ç¡®ä¿æˆ‘ä»¬ç£ç›˜ä¸­çš„ Segment æ–‡ä»¶ä¸ä¼šå æœ‰è¿‡å¤šç³»ç»Ÿèµ„æº, è¿™ä¹ˆåšæœ‰å¦‚ä¸‹å‡ ä¸ªå¥½å¤„:

    - Append-only = sequential write operation (é¡ºåºå†™å…¥). **é¡ºåºå†™å…¥å¾ˆå¿«!!!! é¡ºåºå†™å…¥å¾ˆå¿«!!!! é¡ºåºå†™å…¥å¾ˆå¿«!!!!** é¡ºåºå†™å…¥çš„ç¼“å­˜ä¼˜åŠ¿ååˆ†æ˜æ˜¾, ä¸”ä¸ç®¡åœ¨ HDD è¿˜æ˜¯ SSD éƒ½æ˜¯è¡¨ç°æä½³çš„. å¹¶ä¸”å¦‚æœæˆ‘ä»¬åš Inplace æ›´æ–°çš„è¯, ç”±äºç”¨æˆ·è¯·æ±‚æ˜¯éšæœºçš„, å¾ˆå®¹æ˜“é€ æˆéšæœºç£ç›˜è¯»å†™, ä¼—æ‰€å‘¨çŸ¥, ä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿè®¾è®¡çš„éšæœºç£ç›˜è¯»å†™è¶Šå¤š, å°±è®¾è®¡å¾—è¶Šå¤±è´¥.
    - å®Œå…¨ä¸éœ€è¦æ‹…å¿ƒå¹¶å‘æ§åˆ¶å’Œå´©æºƒæ¢å¤. æ•°æ®çš„è¯»å†™å› ä¸ºéƒ½æ˜¯ append-only, æ ¹æœ¬å°±ä¸éœ€è¦åŠ é”. è€Œä¸”æˆ‘ä»¬å®Œå…¨ä¸éœ€è¦æ‹…å¿ƒå½“æˆ‘ä»¬åœ¨ overwrite ä¸€ä¸ªæ•°æ®æ—¶ç³»ç»Ÿçªç„¶æŒ‚äº†, å¯¼è‡´ç³»ç»Ÿä¸­æ–°æ•°æ®å’Œæ—§æ•°æ®åœ¨æ•°æ®åº“ä¸­å¹¶å­˜. ES åœ¨æˆåŠŸå†™å…¥æ•°æ®åä¼šç´§è·Ÿç€å†™ä¸€ä¸ªç‰¹æ®Šæ ‡è¯†, åœ¨è¯»å–æ—¶æ²¡æœ‰ç‰¹æ®Šæ ‡è¯†ç»“å°¾çš„æ•°æ®è·³è¿‡å³å¯.
    - å®šæœŸçš„ Merge å·²æœ‰çš„ Segment æ–‡ä»¶èƒ½æå¤§ç¨‹åº¦çš„é¿å…ç£ç›˜ç©ºé—´é€æ¸å‰²è£‚, æµªè´¹ç³»ç»Ÿèµ„æº. (Defragmentation) å¯è§, Merging è¿‡ç¨‹æ˜¯ååˆ†æ¶ˆè€—ç³»ç»ŸI/O CPUèµ„æºçš„, ESä¼šå¯¹èåˆè¿›è¡Œä¸€å®šçš„èŠ‚æµ, èŠ‚æµæœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥é…ç½®çš„. ES ç”šè‡³æœ‰ä¸“é—¨é€å‡ºæ¥å£å¯ä»¥æ‰‹åŠ¨è§¦å‘.
    - å†…å­˜ä¸­çš„ MemTable ä¹Ÿä¸éœ€è¦æŠŠæ¯ä¸€ä¸ª String éƒ½å»ºç«‹ä¸€ä¸ª Key, å› ä¸º Key æ˜¯æ’åºçš„, æˆ‘ä»¬åªéœ€è¦å½“ç£ç›˜ä¸­çš„ Segment æ–‡ä»¶è¾¾åˆ°ä¸€å®šå¤§å°çš„æ—¶å€™, æŠŠæœ€è¿‘ä¸€æ¬¡å†™å…¥çš„ String å­˜æˆ Key å°±è¡Œ. å‡å¦‚ Memtable ä¸­æœ‰ Key :

        ```
        {
            ...
            "adapt":  segment 1,  offset  0,
            "admire":  segment 2,   offset  31,
            ...
        }

        ```

        æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢ administration, æŠŠ administration æ ¹æ®å­—ç¬¦ä¸²æ’åºè¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾, å‘ç° administration æ¯” adapt å¤§æ¯” admire å°, å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨ä» segment 1, offset 0 åˆ° segment 2, offset 31 ä¸­é—´æŸ¥è¯¢æ•°æ®å³å¯, è¿™ä¸ªä¼˜åŒ–ç¡®ä¿äº† Memtable å§‹ç»ˆèƒ½åœ¨å†…å­˜.

- åŠ¨æ€æ›´æ–°ç´¢å¼• Dynamically Updatable Indices

    ä¸Šé¢æåˆ°æ·»åŠ æ–°documentéœ€è¦é‡æ–°æ„å»ºå€’æ’ç´¢å¼•, æ€ä¹ˆèƒ½å¤Ÿä¼˜åŒ–æ’å…¥æ–°æ•°æ®æ—¶æ–°æ„å»ºå€’æ’ç´¢å¼•æœ€å¤§åŒ–åˆ©ç”¨ä¸å¯å˜æ€§çš„ä¼˜åŠ¿å‘¢?

    ES è¿™è¾¹é‡‡ç”¨äº† Lucene çš„ Pre-Segment Search æ–¹æ³•, å¤§è‡´æ€è·¯æ˜¯, å½“æœ‰æ–° document è¦æ’å…¥æ—¶, ä¸ä¼šé‡æ–°æ„å»ºæ•´ä¸ªå€’æ’ç´¢å¼•, ä¼šå…ˆå†™å…¥ä¸€ä¸ª In-memory buffer, å½“ buffer çš„æ•°æ®åœç•™äº†ä¸€å®šæ—¶é—´å, ä¼šæŠŠbuffer ä¸­çš„æ–‡æ¡£æ„å»ºä¸€ä¸ªæ–°çš„å€’æ’ç´¢å¼• (é™„å±ç´¢å¼•), å¹¶å†™(commit)åœ¨ä¸€ä¸ªæ–°çš„ç´¢å¼•æ–‡ä»¶(segment)é‡Œ. å½“æœç´¢æ—¶, æ¯ä¸ªç´¢å¼•éƒ½ä¼šè¢«è¯·æ±‚, å°†æœ€åçš„ç»“æœæ•´åˆè¿”å›åˆ°ç”¨æˆ·.

    è¿™è¾¹æˆ‘ä»¬æ¥è¯¦ç»†è¿‡ä¸€ä¸‹è¿™ä¸ªæµç¨‹:

    1. å½“æœ‰æ–°documentè¦æ’å…¥æ—¶, ä¸ä¼šé‡æ–°æ„å»ºæ•´ä¸ªç´¢å¼•, å…ˆæŠŠæ¯ä¸€ä¸ªæ–‡ä»¶æ„å»ºä¸€ä¸ªå€’æ’ç´¢å¼•, ç„¶åå­˜åœ¨ä¸€ä¸ªIn-memory bufferé‡Œé¢, æœªæ¥çŸ­æ—¶é—´å†…çš„è¯»å†™ä¼šä¼˜å…ˆæŸ¥è¯¢å†…å­˜ä¸­çš„ç´¢å¼•, å¦‚æœæ²¡æœ‰å‘½ä¸­, å†è½ç›˜æŸ¥è¯¢.
    2. å½“è¿‡äº†ä¸€å®šçš„æ—¶é—´é™åˆ¶ (é»˜è®¤1s, å¯åŠ¨æ€é…ç½®), ESä¼š commit buffer ä¸­çš„æ–‡æ¡£. Commit ä¼šæŠŠå½“å‰æ–‡æ¡£çš„ä¿¡æ¯å…ƒæ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ª commit log æ–‡ä»¶ä¸­, ä¸»è¦ç”¨äºå½“ç³»ç»Ÿå´©æºƒå, èƒ½å¤Ÿåœ¨é‡å¯æ—¶å›æ”¾ä¹‹å‰çš„æ•°æ®æ¥ä¿è¯æ•°æ®çš„æŒä¹…æ€§.
    3. åœ¨ Commit Log ä¸­ç•™ä¸‹è®°å½•å, ä¼šæŠŠ buffer ä¸­çš„ document çš„åœ¨ä¸Šä¸€æ­¥æ„å»ºå‡ºæ¥çš„å€’æ’ç´¢å¼• å†™åˆ°æ–°çš„ Segment æ–‡ä»¶ä¸­(é™„å±ç´¢å¼•), è¿™ä¸ªè¿‡ç¨‹æˆä¸ºåˆ·æ–° (refresh)
    4. å°†è¿™ä¸ªæ–°Segmentæ–‡ä»¶è·¯å¾„çš„ + å·²çŸ¥Segmentæ–‡ä»¶è·¯å¾„å†™åˆ°ä¸€ä¸ªæ–° Commit Point æ–‡ä»¶, å†™å…¥ç£ç›˜. ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤« (æ³¨æ„è¿™ä¸ªå°è¡¨æƒ…)

        ![image/1611887977399_59f866034a614fba68a96594bce15c12.png](image/1611887977399_59f866034a614fba68a96594bce15c12.png)

    5. æ‰§è¡Œfsyncç³»ç»Ÿè°ƒç”¨, å°†æ‰€æœ‰ç¼“å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜. ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤« (æ³¨æ„è¿™ä¸ªå°è¡¨æƒ…)

        ![image/1611887977294_4fd2042f5b96d215aa916fcfcd04640a.png](image/1611887977294_4fd2042f5b96d215aa916fcfcd04640a.png)

    6. å°†æ–°çš„ Segment æ ‡è®°ä¸ºå¯æœç´¢, æœªæ¥æœç´¢è¯·æ±‚ä¼šéå†æ‰€æœ‰ç£ç›˜ä¸­æ ‡è®°ä¸ºå¯æœç´¢çš„ Segment æ–‡ä»¶, æ‹¿åˆ°å‘½ä¸­çš„ Posting List, é€šè¿‡å¸¸ç”¨çš„ Skip List å’Œ ES è‡ªç ”çš„ [Roaring Bitmap](https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps) è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„æŠŠæ‰€æœ‰å‘½ä¸­çš„ Posting List åš and, æ‹¿åˆ°æœ€ç»ˆçš„ Document IDs
    7. å°† in-memory buffer æ ‡è®°ä¸ºç©º, å¯æ¥å—æ–° document
- åˆ é™¤å’Œæ›´æ–° Deletes and Updates

    Segment æ˜¯ Immutableçš„, æ‰€ä»¥åˆ é™¤å’Œæ›´æ–°éƒ½ä¸ä¼šæ›´æ”¹æ—§ Segment æ–‡ä»¶.

    é™¤äº† Commit Point æ–‡ä»¶ä»¥å¤–, ESè¿˜ä¼šç»´æŠ¤ä¸€ä¸ª `.del` æ–‡ä»¶, å½“ä¸€ä¸ªæ–‡æ¡£åˆ é™¤çš„æ—¶å€™, ä¼šåœ¨ `.del` æ–‡ä»¶ä¸­è®°å½• Segment 1 ä¸­çš„ offset XX, ä¹Ÿå°±æ˜¯å¤§å®¶ç†Ÿæ‚‰çš„ tombstone. åœ¨æœç´¢æ—¶, æ¯ä¸ª segment ä¸­è¢«æ ‡è®°åˆ é™¤çš„ Posting List ä»ç„¶ä¼šè¢«æœç´¢, ä½†æ˜¯åœ¨æœ€åå°†ç»“æœè¿”å›ç»™å…¶ä»– node æ—¶ä¼šå»æ‰

    æ›´æ–°ä¹Ÿæ˜¯ç›¸ä¼¼çš„åŸç†, ä¼šæŠŠæ—§ document æ ‡è®°ä¸ºåˆ é™¤, æŠŠæ–°ç‰ˆæœ¬çš„ document å†™åˆ°æ–° Segment ä¸­, æœç´¢æ—¶æ–°æ—§ç‰ˆæœ¬å‡ä¼šè¢«æœç´¢, è¿”å›æ—¶åšè¿‡æ»¤.

é€šè¿‡ä¸Šé¢çš„ä»‹ç», æˆ‘ä»¬ç†è§£äº† ES é€šè¿‡åˆ©ç”¨ SSTable + LSM Tree å¼ºåˆ¶ç£ç›˜é¡ºåºå†™å…¥æ¥ä¼˜åŒ–å†™å…¥é€Ÿåº¦, å¹¶ç¼“å­˜å€’æ’ç´¢å¼•åˆ°å†…å­˜ä»¥åŠ SSTable äºŒåˆ†æŸ¥æ‰¾æ¥ä¼˜åŒ–è¯»å–é€Ÿåº¦, ä»¥åŠ ES åˆ¶å®šé»˜è®¤è¿›ç¨‹å®šæœŸåˆå¹¶ç£ç›˜ä¸­çš„ Segment æ–‡ä»¶æ¥ä¼˜åŒ–èµ„æºå ç”¨. ç„¶è€Œ, å…¶å®çœŸæ­£æ ¸å¿ƒè¿˜ä¸åœ¨è¿™é‡Œ.

- æˆ‘è§‰å¾—æ²¡ä»€ä¹ˆç‰¹æ®Šçš„å•Š, æ„Ÿè§‰åè€Œå¤æ‚åŒ–äº†å‘€, æ€ä¹ˆå°±Near Real-Time Searchäº†?

    è¿˜è®°å¾—æˆ‘è®©å¤§å®¶è®°ä½è¿™ä¸ªå°è¡¨æƒ…å—, å®é™…ä¸Š, è¿™äº›è¢«å°è¡¨æƒ…æ ‡è®°äº†çš„æ­¥éª¤æ ¹æœ¬éƒ½æ²¡æœ‰è¢« ES æ‰§è¡Œ, æ˜¯æˆ‘éª—äº†å¤§å®¶

    > å°†è¿™ä¸ªæ–°Segmentæ–‡ä»¶è·¯å¾„çš„ + å·²çŸ¥Segmentæ–‡ä»¶è·¯å¾„å†™åˆ°ä¸€ä¸ªæ–° Commit Point æ–‡ä»¶, å†™å…¥ç£ç›˜. ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤« (æ³¨æ„è¿™ä¸ªå°è¡¨æƒ…)

    > æ‰§è¡Œfsyncç³»ç»Ÿè°ƒç”¨, å°†æ‰€æœ‰ç¼“å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜. ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤«ğŸ¤« (æ³¨æ„è¿™ä¸ªå°è¡¨æƒ…)

    ä¸Šè¿°æ ¹æ® Immutable Segment æ–‡ä»¶å»ºç«‹æœç´¢çš„æ–¹æ³•æå¤§çš„æå‡çš„æ–‡æ¡£æ›´æ–°æ•ˆç‡, ä½†ä»ç„¶ä¸å¤Ÿå¿«. çœŸæ­£çš„ç“¶é¢ˆæ˜¯**ç£ç›˜**. å¯¹å“ªæ€•æˆ‘ä»¬ç”¨äº† LSM Tree. çœŸæ­£çš„ç“¶é¢ˆæ˜¯ `fsync` ç³»ç»Ÿè°ƒç”¨, `fsync` **ååˆ†ååˆ†ååˆ†**è€—æ—¶. ESçš„æ€è·¯æ˜¯ç›´æ¥å»æ‰ `fsync` , ä¸å¿…ç­‰å¾… Segment æ–‡ä»¶æŒä¹…åŒ–äº†ä»¥åæ‰å¼€å§‹æœç´¢. åŒæ—¶, ES è¿˜å……åˆ†åˆ©ç”¨äº† Lucene æ”¯æŒå½“æ–‡ä»¶è¢«å†™å…¥ filesystem cache çš„æ—¶å€™å°±æ ‡è®°ä¸ºå¯æœç´¢, è¿™ä¸ªä¼˜åŒ–æå¤§ç¨‹åº¦çš„å¢åŠ äº†æœç´¢æ•ˆç‡.

    ![image/1611887977499_cbd3c3f94a446559bc3a8e940981bec6.png](image/1611887977499_cbd3c3f94a446559bc3a8e940981bec6.png)

- æŒä¹…åŒ– Making Changes Persistent

    å»æ‰ `fsync` çœ‹ä¼¼è’è°¬, é‚£è¿˜æ€ä¹ˆæŒä¹…åŒ–æ•°æ®å‘€?

    ä½†å®é™…ä¸Š ES è‡ªæœ‰ä¸€å¥—åŠæ³•, é‚£å°±æ˜¯ **translog**. å®é™…ä¸Šæ¯ä¸€æ¬¡å¯¹ESçš„æ”¹åŠ¨éƒ½ä¼šå†™å…¥åˆ° translog ä¸­.

    å’±ä»¬æ¥çœ‹ä¸‹ ES å®é™…çš„æ’å…¥æ–‡æ¡£æµç¨‹:

    1. å½“ä¸€ä¸ªdocumentæˆåŠŸå»ºç«‹å€’æ’ç´¢å¼•å, æˆ‘ä»¬ä¸ä»…å†™å…¥åˆ°In-memory buffer, ä¼šåŒæ ·å†™ä¸€ä»½æ•°æ®åˆ°Translog

        ![image/1611887977395_ddd26b7f47e33fc0bd99b967f0dea5e6.png](image/1611887977395_ddd26b7f47e33fc0bd99b967f0dea5e6.png)

    2. æ¯ç§’è¿›è¡Œä¸€æ¬¡åˆ·æ–°: åœ¨ in-memory-buffer ä¸­çš„æ–‡æ¡£å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„ Segment, **ä¸è°ƒç”¨** `fsync` å°†æ–‡ä»¶åŒæ­¥åˆ°ç£ç›˜, å°†æ–° Segment ç›´æ¥æ ‡è®°ä¸ºå¯æœç´¢, å­˜æ”¾åœ¨ filesystem cache ä¸­
    3. å°†in-memory bufferæ ‡è®°ä¸ºç©º, æ–°Segmentæ–‡ä»¶æ ‡è®°ä¸ºå¯æœç´¢

        ![image/1611887977488_d3926d3ade6b754acbb9d0b72022e6af.png](image/1611887977488_d3926d3ade6b754acbb9d0b72022e6af.png)

    4. ç»è¿‡å‡ æ¬¡è¿­ä»£, translogä¸­æ–‡ä»¶è¶Šæ¥è¶Šå¤š

        ![image/1611887977329_8c415dfa8b4f5d7fc59b1c580a3a63e5.png](image/1611887977329_8c415dfa8b4f5d7fc59b1c580a3a63e5.png)

    5. å½“translogä¸­æ–‡ä»¶è¶…å‡ºä¸€å®šå¤§å°æˆ–è¶…å‡ºä¸€å®šæ—¶é—´é™åˆ¶ (æˆ–è€…é»˜è®¤ 30mins, å¯åŠ¨æ€é…ç½®), æ‰§è¡Œä¸€æ¬¡full commit
        - æŠŠæ‰€æœ‰å½“å‰ buffer ä¸­å·²æœ‰æ–‡ä»¶å†™å…¥åˆ°æ–° Segment æ–‡ä»¶ä¸­
        - æ ‡è®° in-memory-buffer ä¸ºç©º
        - å†™å…¥æ–° Commit Point åˆ°ç£ç›˜, âš ï¸ åªæœ‰è¿™ä¸ªæ—¶å€™æ‰è½ç›˜ Commit Point
        - æ¸…ç©ºfile system cache, è°ƒç”¨ `fsync`
        - æ ‡è®° Translog ä¸ºç©º

            ![image/1611887977305_2a1a577839119920c8fb2adb43460f36.png](image/1611887977305_2a1a577839119920c8fb2adb43460f36.png)

    æ¯æ¬¡ ES é€€å‡ºå®ä¾‹å‰, éƒ½ä¼šå¼ºåˆ¶è½ç›˜ä¸€æ¬¡ Translog. æ¯æ¬¡ ES å¯åŠ¨æ—¶, éƒ½ä¼šå…ˆå»æŸ¥æœ€è¿‘ä¸€æ¬¡ Commit Point, è¯»å– Commit Point æŒ‡å‘çš„ Segment æ–‡ä»¶, å¹¶å°†è¿™äº›æ–‡ä»¶ä»ç£ç›˜è¯»åˆ°ç¼“å­˜, å›æ”¾ Translog ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œ. è¿™æ · ES å°±æ¢å¤åˆ°äº†é€€å‡ºå®ä¾‹ä¹‹å‰çš„çŠ¶æ€äº†.

    Translog æœ¬èº«æ˜¯ä¼šé»˜è®¤æ¯5ç§’å’Œç£ç›˜åŒæ­¥ `fsync` ä¸€æ¬¡çš„. ä½ å¯èƒ½ä¼šæƒ³, å‡å¦‚5ç§’åŒºé—´å†… nodeæŒ‚äº†æ€ä¹ˆåŠ, è¿˜è®°å¾—æ¯ä¸ª shard å®é™…ä¸Šæ˜¯æœ‰å¤šä¸ªå‰¯æœ¬çš„ä¸”ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»äº’ä¸å½±å“å—? ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡åŒæ—¶æŒ‚æ‰çš„å¯èƒ½æ€§å¾ˆä½å¾ˆä½, æ€»æœ‰ä¸€ä¸ªåˆ†ç‰‡çš„æ•°æ®æ˜¯å®Œæ•´çš„. å½“ç„¶ä¹Ÿå¯ä»¥é…ç½® `fsync` åŒæ­¥è¯„ç‡, ä¸è¿‡å¾—ä»¥ç‰ºç‰²ä¸€å®šæ€§èƒ½ä¸ºä»£ä»·.

è‡³æ­¤, æˆ‘ä»¬å­¦ä¹ åˆ° ES é€šè¿‡ Translog æœ€å¤§åŒ–å‡å°‘å¯¹ `fsync` çš„è°ƒç”¨ä»¥åŠæè‡´çš„åˆ©ç”¨ filesystem cache æ¥å®ç°æƒŠäººçš„æŸ¥è¯¢é€Ÿåº¦. é™¤æ­¤ä¹‹å¤–, ES é€šè¿‡å®šæœŸçš„è½ç›˜ Translog ä¸­æ–‡ä»¶è¿™ä¸ªæœºåˆ¶æ¥èƒ½å¤Ÿå¿«é€Ÿçš„æœç´¢æ’å…¥çš„åŒæ—¶ä¿è¯çš„æ•°æ®çš„æŒä¹…åŒ–. åšåˆ°çœŸæ­£çš„**æ¥è¿‘å®æ—¶**çš„æœç´¢ä¸”æ•°æ®**é«˜å¯ç”¨**

## 5. ç»“è¯­

ç¬”è€…åœ¨å†™è¯¥æ–‡æ¡£ä¹‹å‰ä¸€ç›´æ²¡æœ‰æ¥è§¦è¿‡ ElasticSearch, ä½†ç¬”è€…å‘ç°è‡ªå·±ä¸Šæ‰‹ç›¸å…³æ–‡çŒ®å’Œä¹¦ç±ç›¸å½“çš„è½»æ¾å®¹æ˜“, ä¸€æ–¹é¢å› ä¸º ElasticSearch å®˜æ–¹æ–‡æ¡£ç®€æ´æ˜äº†, å¦ä¸€æ–¹é¢æ˜¯ç¬”è€…ä¹‹å‰ç”¨è¿‡ Facebook çš„ Cassandra, è€Œä¸¤è€…åº•å±‚çš„è®¾è®¡æå…¶ç›¸ä¼¼, åº•å±‚åŒæ ·éƒ½ä½¿ç”¨ LSM-Tree æ¥åšä¼˜åŒ–, åˆ†å¸ƒå¼è®¾è®¡ä¹Ÿæœ‰å¾ˆå¤šç›¸ä¼¼ä¹‹å¤„. ç¬”è€…æœ€å¤§çš„æ„Ÿè§¦å°±æ˜¯ç»å¤§éƒ¨åˆ†ç³»ç»Ÿè®¾è®¡**å…¶å®éƒ½æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—**. æ—¥å¸¸é˜…è¯»ç§¯ç´¯å¯èƒ½å¯¹å½“ä¸‹æ²¡æœ‰å³åˆ»çš„æ”¶ç›Š, ä½†å¯¹è‡ªå·±é•¿æœŸçš„ä¸ªäººæŠ€æœ¯æˆé•¿è¿˜æ˜¯å¤§æœ‰è£¨ç›Šçš„.

## 6. æ‰©å±•é˜…è¯»:

- Googleä¹‹çˆ¶æœç´¢é¢†åŸŸå…³é”®è®ºæ–‡ [The Anatomy of a Large-Scale Hypertextual Web Search Engine](http://infolab.stanford.edu/%5C~backrub/google.html)
- Cassandra è®ºæ–‡ [Cassandra - A Decentralized Structured Storage System](https://www.cs.cornell.edu/projects/ladis2009/papers/lakshman-ladis2009.pdf)
- BigTable è®ºæ–‡ (LSM Treeä¹‹çˆ¶) [Bigtable: A Distributed Storage System for Structured Data](https://static.googleusercontent.com/media/research.google.com/en//archive/bigtable-osdi06.pdf)
- [Lucene in Action](https://www.manning.com/books/lucene-in-action)
- [Frame of Reference and Roaring Bitmaps](https://www.elastic.co/blog/frame-of-reference-and-roaring-bitmaps)
- [Analysis of Lucene - Basic Concepts](https://www.alibabacloud.com/blog/analysis-of-lucene---basic-concepts%5C_594672)
- äºšé©¬é€Šæ”¾å¼ƒES, é‡æ–°ç”¨åŸç”ŸLucene [What Amazon gets by giving back to Apache Lucene](https://aws.amazon.com/blogs/opensource/amazon-giving-back-apache-lucene/)
- [æ·±å…¥ç†è§£Elasticsearchå†™å…¥è¿‡ç¨‹](https://zhuanlan.zhihu.com/p/94915597)
- [Lucene æŸ¥è¯¢åŸç†åŠè§£æ](https://www.infoq.cn/article/ejeg02vroegvalw4j_ll)
- [ElasticSearch The Definitive Guide](https://www.elastic.co/guide/en/elasticsearch/guide/index.html)
- è…¾è®¯å…³äº ES å†…æ ¸åº•å±‚ä¼˜åŒ–åšæ–‡ [è…¾è®¯Elasticsearchæµ·é‡è§„æ¨¡èƒŒåçš„å†…æ ¸ä¼˜åŒ–å‰–æ](https://zhuanlan.zhihu.com/p/139725905)